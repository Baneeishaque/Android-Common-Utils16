sequenceDiagram
    participant Agent as Build Agent
    participant Common as common.ps1
    participant Setup as setup-mise-java.ps1
    participant Build as Gradle@3
    participant Stop as gradle-stop.ps1

    Note over Agent: Job starts → OS image loaded

    Agent->>Setup: Invoke setup-mise-java.ps1
    Setup->>Common: Dot-source common.ps1 (helpers)
    Common-->>Setup: Functions loaded<br/> (Get-OS, Add-Path, Ensure-PackageManagers, Ensure-Mise, Gradle-Wrapper)

    Setup->>Agent: Set $(MISE_DATA_DIR), $(MISE_CACHE_DIR) for cache
    Note over Agent: Single Cache@2 step uses these vars<br/>to restore/save mise dirs

    Setup->>Setup: Ensure package managers & install mise
    Setup->>Setup: Read Java pin from mise.toml
    Setup->>Setup: Install Java via mise & run guards
    Setup->>Agent: Set $(JAVA_HOME) for build
    Setup->>Setup: Extra audit — list all java on PATH, Gradle's JDK

    Agent->>Build: Run Gradle build with JAVA_HOME

    Build->>Stop: Invoke gradle-stop.ps1
    Stop->>Common: Dot-source common.ps1
    Common-->>Stop: Gradle-Wrapper loaded
    Stop->>Stop: gradlew --stop (if present)

    Note over Agent: Job ends → caches saved
